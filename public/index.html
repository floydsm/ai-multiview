<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Millicast Multiviewer (Netlify)</title>
  <style>
    :root { color-scheme: dark; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:#111; color:#fff; }
    header { display:flex; gap:8px; align-items:center; padding:12px; background:#1a1a1a; position:sticky; top:0; z-index:10; }
    button { background:#6d5bf6; color:#fff; border:0; padding:8px 12px; border-radius:10px; cursor:pointer; }
    button:disabled { opacity:.6; cursor:default; }
    input[type=number], input[type=text] { padding:6px 8px; border-radius:8px; border:0; }
    .grid { display:grid; gap:8px; padding:12px; }
    .tile { background:#000; border-radius:10px; position:relative; overflow:hidden; }
    .badge { position:absolute; left:8px; top:8px; background:rgba(0,0,0,.6); padding:4px 8px; border-radius:8px; font-size:12px; }
    .tile button.small { position:absolute; right:8px; bottom:8px; font-size:12px; background:rgba(255,255,255,.2); }
    .error { background:#b00020; padding:8px 12px; margin:12px; border-radius:8px; }
    iframe { width:100%; height:100%; border:0; }
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- React via CDN (no build step) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <script>
    const { useState, useEffect, useMemo } = React;

    async function fetchActiveStreams() {
      const r = await fetch('/.netlify/functions/millicast', { method:'POST' });
      if (!r.ok) throw new Error(await r.text());
      return (await r.json()).streams;
    }

    async function askAssistant(prompt) {
      const r = await fetch('/.netlify/functions/assistant', {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ prompt })
      });
      if (!r.ok) throw new Error(await r.text());
      return await r.json();
    }

    function App(){
      const [rows,setRows] = useState(2);
      const [cols,setCols] = useState(2);
      const [slots,setSlots] = useState(Array.from({length:4},()=>({name:'Empty', url:''})));
      const [spot,setSpot] = useState(null);
      const [cmd,setCmd] = useState('');
      const [loading,setLoading]=useState(false);
      const [err,setErr]=useState('');

      useEffect(()=>{
        const total = rows*cols;
        setSlots(prev=>{
          const n = prev.slice(0,total);
          while(n.length<total) n.push({name:'Empty', url:''});
          return n;
        });
      },[rows,cols]);

      async function loadActive(){
        try{
          setLoading(true); setErr('');
          const streams = await fetchActiveStreams();
          setSlots(s=> s.map((slot,i)=> streams[i] ? {name: streams[i].name || ('Stream '+(i+1)), url: streams[i].playerUrl || ''} : slot));
        }catch(e){ setErr(e.message || 'Failed to load'); }
        finally{ setLoading(false); }
      }

      function applyIntent(intent){
        if(!intent || !intent.type) return;
        if(intent.type==='setGrid'){ setRows(intent.rows); setCols(intent.cols); setSpot(null); }
        if(intent.type==='fullscreen'){ const idx = intent.slot-1; setSpot(Number.isInteger(idx)?idx:null); }
        if(intent.type==='swap'){
          setSlots(prev=>{
            const a=intent.a-1, b=intent.b-1; const c=prev.slice();
            if(c[a] && c[b]){ const t=c[a]; c[a]=c[b]; c[b]=t; }
            return c;
          });
        }
        if(intent.type==='loadActive'){ loadActive(); }
        if(intent.type==='setStream'){
          const idx=intent.slot-1;
          setSlots(prev=> prev.map((s,i)=> i===idx ? { ...s, url:intent.playerUrl } : s));
        }
        if(intent.type==='nameSlot'){
          const idx=intent.slot-1;
          setSlots(prev=> prev.map((s,i)=> i===idx ? { ...s, name:intent.name } : s));
        }
        if(intent.type==='preset'){
          if(intent.action==='save'){
            const p = { rows, cols, slots };
            localStorage.setItem('mv_preset_'+intent.name, JSON.stringify(p));
          }else if(intent.action==='load'){
            const raw = localStorage.getItem('mv_preset_'+intent.name);
            if(raw){ try{ const p=JSON.parse(raw); setRows(p.rows); setCols(p.cols); setSlots(p.slots); setSpot(null);}catch{} }
          }else if(intent.action==='delete'){
            localStorage.removeItem('mv_preset_'+intent.name);
          }
        }
      }

      async function run(){
        if(!cmd.trim()) return;
        try{ setLoading(true); setErr(''); const intent = await askAssistant(cmd.trim()); applyIntent(intent); }
        catch(e){ setErr(e.message || 'Assistant error'); }
        finally{ setLoading(false); setCmd(''); }
      }

      const gridStyle = useMemo(()=>({ gridTemplateColumns: `repeat(${cols}, 1fr)`, gridTemplateRows:`repeat(${rows}, minmax(0, 33vh))` }),[rows,cols]);

      return React.createElement(React.Fragment, null,
        React.createElement('header', null,
          React.createElement('button', {onClick:loadActive, disabled:loading}, 'Load Active'),
          React.createElement('span', {style:{marginLeft:12}}, 'Rows'),
          React.createElement('input', {type:'number', min:1, max:6, value:rows, onChange:(e)=>setRows(parseInt(e.target.value)||1)}),
          React.createElement('span', {style:{marginLeft:8}}, 'Cols'),
          React.createElement('input', {type:'number', min:1, max:6, value:cols, onChange:(e)=>setCols(parseInt(e.target.value)||1)}),
          React.createElement('input', {style:{marginLeft:'auto', width:420}, type:'text', placeholder:"Type a command like '3x3' or 'fullscreen 2'", value:cmd, onChange:e=>setCmd(e.target.value), onKeyDown:e=>{if(e.key==='Enter') run();}}),
          React.createElement('button', {onClick:run, disabled:loading, style:{marginLeft:8}}, 'Send')
        ),
        err && React.createElement('div', {className:'error'}, err),
        spot!==null ? React.createElement('div', {style:{padding:12}},
          React.createElement('div', {className:'tile', style:{height:'80vh'}}, 
            React.createElement('div', {className:'badge'}, slots[spot]?.name || ('Slot '+(spot+1)) ),
            React.createElement('iframe', {src: slots[spot]?.url || 'about:blank', allow:'autoplay; fullscreen'}),
            React.createElement('button', {className:'small', onClick:()=>setSpot(null)}, 'Exit')
          )
        ) : React.createElement('div', {className:'grid', style: gridStyle},
          slots.map((s,i)=> React.createElement('div', {className:'tile', key:i, style:{minHeight:'200px'}},
            React.createElement('div', {className:'badge'}, s.name || ('Slot '+(i+1))),
            React.createElement('iframe', {src: s.url || 'about:blank', allow:'autoplay; fullscreen'}),
            React.createElement('button', {className:'small', onClick:()=>setSpot(i)}, 'Fullscreen')
          ))
        )
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(App));
  </script>
</body>
</html>
